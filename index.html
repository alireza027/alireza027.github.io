<!doctypehtml><html dir=rtl lang=fa><meta charset=UTF-8><meta content="width=device-width,initial-scale=1"name=viewport><title>بررسی رسید ویزیت</title><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap"rel=stylesheet><link href=./normalize.css rel=stylesheet><link href=./persianDatepicker.css rel=stylesheet><style>:root{color-scheme:light;--bg:#0d2538;--card-bg:#f9fbfc;--border:#c8d6df;--primary:#1a9cf3;--primary-dark:#1472c4;--accent:linear-gradient(100deg, #1969ffb7, #0fc286b0);--text:#1a2c3b;--muted:#7b8a99;--radius-lg:24px;--radius-md:14px;--shadow:0 18px 45px rgba(3, 30, 66, 0.18)}*{box-sizing:border-box}body{margin:0;min-height:100vh;font-family:Vazirmatn,sans-serif;background:radial-gradient(circle at top,rgba(19,116,182,.5),rgba(10,33,46,1)) var(--bg);display:flex;align-items:center;justify-content:center;color:var(--text)}.card{width:min(700px,100%);background:var(--card-bg);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:clamp(20px,2vw,30px)}.flex-box{display:flex;gap:1rem}.flex-wrap{flex-wrap:wrap}.w-full{width:100%}.justify-between{justify-content:space-between}.align-center{align-items:center}.success-message{background:linear-gradient(135deg,#10b981 0,#059669 100%);color:#fff;padding:15px 20px;border-radius:14px;margin-top:20px;display:none;text-align:center;font-weight:700;animation:slideIn .6s ease;box-shadow:0 6px 20px rgba(16,185,129,.3);font-size:15px}.success-message.show{display:block}.card__title{text-align:center;font-size:1.6rem;color:#0f7d59;margin-top:0;margin-bottom:10px;font-weight:700}.upload-zone{border:2px dashed #79d4b4;border-radius:var(--radius-md);padding:10px;text-align:center;background:linear-gradient(135deg,rgba(25,107,255,.08),rgba(15,194,134,.08));transition:border-color .2s,background .2s;cursor:pointer;position:relative;margin-bottom:10px}.upload-zone.is-dragover{border-color:#0fc286;background:linear-gradient(135deg,rgba(25,107,255,.18),rgba(15,194,134,.18))}.upload-zone input[type=file]{inset:0;opacity:0;position:absolute;cursor:pointer}.upload-zone__icon{width:52px;margin-bottom:10px}.upload-zone__hint{color:var(--muted);font-size:.95rem}form{display:grid;gap:5px;margin-top:24px}label{display:flex;flex-direction:column;gap:6px;font-weight:500;color:var(--text)}input::placeholder{color:#4e4e4e69}select option[value=""]{display:none}input,select{border:1.5px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;font-family:inherit;transition:border-color .2s,box-shadow .2s;background:#fff}input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(26,156,243,.15);outline:0}::picker(select),select{appearance:base-select}*{box-sizing:border-box}select{flex:1;transition:.4s}select::picker-icon{color:#999;transition:.4s rotate}select:open::picker-icon{rotate:180deg}.error{color:#c0392b;font-size:.85rem;min-height:10px}.file-name{margin-top:10px;font-size:.92rem;color:var(--text)}.check-icon{position:absolute;left:18px;top:44px;width:28px;height:28px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:16px;font-weight:700;opacity:0;transform:scale(0) rotate(-45deg);transition:all .5s cubic-bezier(.68,-.55,.265,1.55);box-shadow:0 4px 12px rgba(16,185,129,.4)}.gap-0{gap:0}.check-icon.show{opacity:1;transform:scale(1) rotate(0)}.submit-btn{border:none;border-radius:18px;padding:16px;font-size:1.05rem;font-weight:600;color:#fff;background-image:var(--accent);cursor:pointer;transition:transform .2s,box-shadow .2s,opacity .2s;display:inline-flex;justify-content:center}.form-group{position:relative}.submit-btn:disabled{background:linear-gradient(135deg,#94a3b8 0,#cbd5e1 100%);cursor:not-allowed;transform:none;box-shadow:none}.submit-btn:not(:disabled):hover{transform:translateY(-1px);background-image:var(--accent);box-shadow:0 10px 25px rgba(1,155,120,.4)}@media (max-width:520px){.card{border-radius:16px}label{font-size:.95rem}}.preview-container{margin-top:15px;display:none;animation:fadeIn .4s ease;max-height:35vh;overflow-y:auto}.preview-image{max-width:100%;max-height:500px;border-radius:12px;box-shadow:0 8px 25px rgba(0,0,0,.15);border:3px solid #e0e7ff}.spinner{width:40px;height:40px;border:8px solid rgba(59,130,246,.2);border-top-color:#3b82f6;border-right-color:#10b981;border-radius:50%;animation:spin 1.2s linear infinite;box-shadow:0 0 30px rgba(59,130,246,.3)}@keyframes spin{to{transform:rotate(360deg)}}#receiptForm{margin:0}.autocomplete-wrapper{position:relative}.suggestions{display:none;position:absolute;top:100%;right:0;left:0;background:#fff;border:1px solid var(--border);z-index:1;border-radius:5px}.suggestions .suggestion-item{padding:5px;border-radius:5px}.suggestions .suggestion-item:not(.loading){font-size:14px;cursor:pointer}.suggestions .suggestion-item:not(.loading):hover{background:#38383813}</style><main aria-labelledby=form-title class=card><form id=receiptForm><h1 class=card__title id=form-title>بررسی رسید ویزیت</h1><section aria-label="آپلود تصویر رسید"class=upload-zone id=dropZone role=button tabindex=0><input id=receiptFile accept=image/* type=file><div id=info-uploader><img alt=""class=upload-zone__icon aria-hidden=true src=./upload-icon.gif><div class=upload-zone__hint>برای آپلود تصویر کلیک کنید یا فایل را بکشید</div><span class=file-name id=fileName>فایلی انتخاب نشده است</span></div><div class=preview-container id=previewContainer><img alt=Preview class=preview-image id=previewImage></div></section><label class=form-group for=specific_letter>نوع خدمت <select id=specific_letter name=specific_letter required><option value="">انتخاب کنید<option value=ویزیت selected>ویزیت<option value=داروخانه disabled>داروخانه</select> <span class=error data-error-for=specific_letter></span> <span class=check-icon id=check-specific_letter>✓</span></label><div class="w-full align-center flex-box"><label class="w-full form-group"for=insured_name>نام بیمه‌شده<div class="w-full autocomplete-wrapper"><input id=insured_name name=insured_name placeholder="نام بیمه شده"required class="w-full autocomplete-input"><div class=suggestions></div></div><span class=error data-error-for=insured_name></span> <span class=check-icon id=check-insured_name>✓</span></label> <label class="w-full form-group"for=doctor_name>نام پزشک<div class="w-full autocomplete-wrapper"><input id=doctor_name name=doctor_name placeholder="نام پزشک"required class="w-full autocomplete-input"><div class=suggestions></div></div><span class=error data-error-for=doctor_name></span> <span class=check-icon id=check-doctor_name>✓</span></label></div><div class="align-center flex-box"><label class="w-full form-group"for=date>تاریخ <input id=date name=date placeholder=۱۴۰۴/۰۹/۰۵ required> <span class=error data-error-for=date></span> <span class=check-icon id=check-date>✓</span></label> <label class="w-full form-group"for=amount>مبلغ (ریال) <input id=amount name=amount placeholder="مبلغ پرداخت شده"required> <span class=error data-error-for=amount></span> <span class=check-icon id=check-amount>✓</span></label></div><button class=submit-btn type=submit>بررسی رسید</button><div class=success-message id=successMessage></div><div class=error-message id=errorMessage></div></form></main><script def src=./jquery.min.js></script><script def src=./persiandate.min.js></script><script def src=./persiandatepicker.min.js></script><script>const API_URL = "https://authvision.yarhis.ir/api/v1";
      const timeout = {};
      $(function () {
        $("#date").pDatepicker({
          initialValue: false,
          format: "YYYY/MM/DD",
        });
      });

      $(document).on("click", function (e) {
        if (!$(e.target).closest(".autocomplete-wrapper").length) {
          $(".suggestions:not(.loading)").hide();
        }
      });

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("receiptFile");
      const fileName = document.getElementById("fileName");
      const validationForm = document.getElementById("receiptForm");
      const submitBtn = validationForm.querySelector(".submit-btn");
      const successMessage = document.getElementById("successMessage");
      const errorMessage = document.getElementById("errorMessage");

      let selectedFile = null;

      $(".autocomplete-input").on("input", function () {
        const value = $(this).val(),
          name = $(this).attr("name");
        isDoctor = name === "doctor_name";
        const suggestionsContainer = $(this).siblings(".suggestions");
        clearTimeout(timeout[name]);
        timeout[name] = setTimeout(() => {
          $.ajax({
            url: isDoctor
              ? `https://darman-admin.alborzinsurance.ir/personManagment/tpa-api/doctor`
              : "https://darman-admin.alborzinsurance.ir/personManagment/tpa-api/person-autocomplete",
            headers: {
              Authorization: "Bearer MO3xBCHrt8CNQ-AMioEz8iFnXsl4ZoHZ",
            },
            method: "GET",
            data: { q: value ? value.trim() : "" },
            beforeSend: () => {
              $(this).siblings(".suggestions").show().html(`
                <div class="suggestion-item loading">
                  درحال بارگذاری...
                </div>
              `);
              $(this).siblings(".suggestions").addClass("loading");
            },
            success: function (data) {
              let items = "";
              if (!isDoctor)
                data.forEach((suggestion) => {
                  items += `<div class="suggestion-item" data-value="${suggestion.name}">${suggestion.text}</div>`;
                });
              else
                data.items.forEach((suggestion) => {
                  items += `<div class="suggestion-item" data-value="${suggestion.name}">${suggestion.text}</div>`;
                });
              suggestionsContainer.show();
              suggestionsContainer.html(items);
            },
            complete: () => {
              suggestionsContainer.removeClass("loading");
            },
          });
        }, 500);
      });

      $(document).on("click", ".suggestion-item", function () {
        const value = $(this).data("value");
        $(this)
          .closest(".autocomplete-wrapper")
          .find(".autocomplete-input")
          .val(value);
        $(this).parent().empty().hide();
      });

      const requiredFields = [
        "date",
        "amount",
        "specific_letter",
        "insured_name",
        "doctor_name",
      ];

      function handleFile(file) {
        if (file && file.type.startsWith("image/")) {
          selectedFile = file;
          const reader = new FileReader();
          reader.onload = (e) => {
            previewImage.src = e.target.result;
            previewContainer.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      // Drag and drop
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("is-dragover");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("is-dragover");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        fileInput.files = e.dataTransfer.files;
        handleFile(e.dataTransfer.files[0]);
      });

      // File selection
      fileInput.addEventListener("change", (e) => {
        handleFile(e.target.files[0]);
        $("#info-uploader").hide();
      });

      const showError = (input, message) => {
        const errorEl = validationForm.querySelector(
          `[data-error-for="${input.id}"]`
        );
        if (errorEl) {
          errorEl.textContent = message;
          input.setAttribute("aria-invalid", Boolean(message));
        }
      };

      const validateField = (input) => {
        let message = "";
        if (input.validity.valueMissing) {
          message = "پر کردن این فیلد الزامی است.";
        } else if (input.validity.rangeUnderflow) {
          message = "مبلغ نمی‌تواند کمتر از حداقل باشد.";
        }
        showError(input, message);
        return !message;
      };

      validationForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!selectedFile) {
          showError("❌ لطفاً تصویر رسید را آپلود کنید");
          return;
        }

        // Reset validation states
        document.querySelectorAll(".check-icon").forEach((icon) => {
          icon.classList.remove("show");
        });
        document.querySelectorAll("input").forEach((input) => {
          input.classList.remove("validated", "validating");
        });
        errorMessage.classList.remove("show");
        successMessage.classList.remove("show");

        // Show validating state
        document.querySelectorAll("input").forEach((input) => {
          input.classList.add("validating");
        });

        // Show loader

        // Prepare form data
        const formData = new FormData();
        formData.append("image", selectedFile);
        formData.append("date", document.getElementById("date").value);
        formData.append("amount", document.getElementById("amount").value);
        formData.append(
          "specific_letter",
          document.getElementById("specific_letter").value
        );
        formData.append(
          "insured_name",
          document.getElementById("insured_name").value
        );
        formData.append(
          "doctor_name",
          document.getElementById("doctor_name").value
        );

        try {
          $(".submit-btn").html('<div class="spinner"></div>');
          $(".submit-btn").prop("disabled", true);
          const response = await fetch(`${API_URL}/validate-receipt/`, {
            method: "POST",
            body: formData,
            headers: {
              "x-api-key":
                "6245b7e11683c3fc0767237c44671f2172a9477507409c2321f8f3ed84579cac",
            },
          });

          const data = await response.json();

          if (data.success) {
            // Remove validating state
            document.querySelectorAll("input").forEach((input) => {
              input.classList.remove("validating");
            });

            // Animate validated fields with delays
            let delay = 0;
            let validCount = 0;
            for (const [key, isValid] of Object.entries(data.results)) {
              if (isValid) {
                validCount++;
                setTimeout(() => {
                  const input = document.getElementById(key);
                  const checkIcon = document.getElementById(`check-${key}`);
                  input.classList.add("validated");
                  checkIcon.classList.add("show");
                }, delay);
                delay += 300;
              }
            }

            // Show success message
            setTimeout(() => {
              successMessage.textContent = ` بررسی کامل شد! ${validCount} از ${
                Object.keys(data.results).length
              } فیلد تایید شد✅`;
              successMessage.classList.add("show");
            }, delay + 200);
          } else {
            showError("❌ خطا در پردازش: " + data.error);
          }
        } catch (error) {
          showError("❌ خطا در ارتباط با سرور: " + error.message);
        } finally {
          $(".submit-btn").html("بررسی رسید");
          $(".submit-btn").removeAttr("disabled");
        }
      });</script>